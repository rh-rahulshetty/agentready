name: Publish to PyPI

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (leave empty to use current version from pyproject.toml)'
        required: false
        type: string
      dry_run:
        description: 'Perform a dry run (publish to TestPyPI instead)'
        required: false
        type: boolean
        default: true

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for trusted publishing

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Update version if specified
        if: inputs.version != ''
        env:
          VERSION: ${{ inputs.version }}
        run: |
          # Update version in pyproject.toml
          sed -i "s/^version = .*/version = \"$VERSION\"/" pyproject.toml
          echo "Updated version to $VERSION"

      - name: Build package
        run: |
          python -m build
          echo "ðŸ“¦ Built distribution files:"
          ls -lh dist/

      - name: Check distribution
        run: |
          twine check dist/*

      - name: Publish to TestPyPI (dry run)
        if: inputs.dry_run == true
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_TOKEN }}
        run: |
          echo "ðŸ§ª Publishing to TestPyPI..."
          twine upload --repository testpypi dist/*
          echo "âœ… Published to TestPyPI: https://test.pypi.org/project/agentready/"

      - name: Publish to PyPI (production)
        if: inputs.dry_run == false
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
        run: |
          echo "ðŸš€ Publishing to PyPI..."
          twine upload dist/*
          echo "âœ… Published to PyPI: https://pypi.org/project/agentready/"

      - name: Create GitHub Release
        if: inputs.dry_run == false && inputs.version != ''
        env:
          VERSION: ${{ inputs.version }}
        uses: actions/github-script@v7
        with:
          script: |
            const version = process.env.VERSION;
            const tag = `v${version}`;

            // Create tag
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${tag}`,
              sha: context.sha
            });

            // Create release
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: `Release ${version}`,
              body: `Published to PyPI: https://pypi.org/project/agentready/${version}/`,
              draft: false,
              prerelease: false
            });

      - name: Summary
        env:
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          echo "## Publication Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$DRY_RUN" == "true" ]; then
            echo "âœ… **Dry Run Complete**" >> $GITHUB_STEP_SUMMARY
            echo "Published to TestPyPI: https://test.pypi.org/project/agentready/" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To install and test:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "pip install --index-url https://test.pypi.org/simple/ agentready" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸš€ **Published to PyPI**" >> $GITHUB_STEP_SUMMARY
            echo "Package: https://pypi.org/project/agentready/" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To install:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "pip install agentready" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
